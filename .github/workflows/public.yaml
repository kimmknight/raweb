name: Preview

on:
  # for building backend (with artifact output) AND frontend
  push:
    paths:
      - "frontend/**"
      - "dotnet/**"
      - ".github/workflows/public.yaml"
      - "setup.ps1"

  # for building frontend
  pull_request_target:
    types: [opened, synchronize, reopened]
    paths:
      - "frontend/**"

  # manual trigger
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

concurrency: ci-${{ github.ref }}

jobs:
  build-and-preview:
    name: Build web app (frontend)
    runs-on: ubuntu-latest

    if: ${{ !github.event.act }}

    outputs:
      preview_success: ${{ steps.push.outputs.success }}
      target_name: ${{ steps.context.outputs.target_name }}
      ref_name: ${{ steps.context.outputs.ref_name }}
      skipped: ${{ steps.push.outputs.reason != '' && steps.push.outputs.success != 'true' }}
      failed: ${{ steps.build.outcome != 'success' || (steps.push.outputs.success != 'true' && steps.push.outputs.reason == '') }}
      deploy_url: ${{ steps.push.outputs.deploy_url }}

    steps:
      - name: Find existing PR comment
        if: github.event_name == 'pull_request_target'
        id: find_comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: "<!-- DEPLOY-PREVIEW-COMMENT -->"

      - name: Update status
        if: github.event_name == 'pull_request_target'
        id: pr_comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          body: |
            <!-- DEPLOY-PREVIEW-COMMENT -->
            üöÄ **Deployment started...**
            [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            <div>
            <b>Local install</b></br>
            Run as an administrator in PowerShell to install this branch:

            ```bash
            iwr -UseBasicParsing install.raweb.app/preview/${{ github.event.pull_request.head.repo.owner.login || github.repository_owner }}/${{ steps.context.outputs.ref_name }} | iex
            ```
            </div>
          edit-mode: replace

      - name: Get GitHub Pages settings (detect custom domain)
        id: pages
        uses: octokit/request-action@v2.x
        continue-on-error: true
        with:
          route: GET /repos/${{ github.repository }}/pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Parse custom domain
        id: domain
        run: |
          if [ -n "${{ steps.pages.outputs.status }}" ] && [ "${{ steps.pages.outputs.status }}" -ne 404 ]; then
            domain=$(echo '${{ steps.pages.outputs.data }}' | jq -r '.cname // ""')
          else
            echo "No existing Pages configuration; treating as no custom domain."
            domain=""
          fi
          echo "custom_domain=${domain}" >> $GITHUB_OUTPUT

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: >
            ${{ github.event_name == 'pull_request_target'
              && format('refs/pull/{0}/merge', github.event.pull_request.number)
              || github.ref }}

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.11
          run_install: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.15.0"
          cache: "pnpm"
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: cd frontend && pnpm install

      - name: Determine deployment target
        id: context
        run: |
          if [ "${{ github.event_name }}" = "pull_request_target" ]; then
            branch="${{ github.head_ref }}"
            echo "target_name=pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "ref_name=${branch}" >> $GITHUB_OUTPUT
          else
            echo "target_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "ref_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          fi

      - name: Update status
        if: github.event_name == 'pull_request_target'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find_comment.outputs.comment-id || steps.pr_comment.outputs.comment-id }}
          body: |
            <!-- DEPLOY-PREVIEW-COMMENT -->
            üèóÔ∏è **Building web app...**
            [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            <div>
            <b>Local install</b></br>
            Run as an administrator in PowerShell to install this branch:

            ```bash
            iwr -UseBasicParsing install.raweb.app/preview/${{ github.event.pull_request.head.repo.owner.login || github.repository_owner }}/${{ steps.context.outputs.ref_name }} | iex
            ```
            </div>
          edit-mode: replace

      - name: Build the frontend
        id: build
        env:
          CUSTOM_DOMAIN: ${{ steps.domain.outputs.custom_domain }}
          TARGET_NAME: ${{ steps.context.outputs.target_name }}
        continue-on-error: ${{ github.event_name == 'pull_request_target' }}
        run: |
          # custom domain in use ‚Üí no repository prefix
          if [ -n "${CUSTOM_DOMAIN}" ]; then
            if [ "${{ steps.context.outputs.ref_name }}" = "master" ]; then
              RAWEB_PUBLIC_BASE="/"
            else
              RAWEB_PUBLIC_BASE="/deploy-preview/${TARGET_NAME}/"
            fi

          # otherwise, use repository prefix, which is required with the GitHub Pages default domain
          else
            # Default GitHub Pages domain (includes repo name)
            if [ "${{ steps.context.outputs.ref_name }}" = "master" ]; then
              RAWEB_PUBLIC_BASE="/${{ github.event.repository.name }}/"
            else
              RAWEB_PUBLIC_BASE="/${{ github.event.repository.name }}/deploy-preview/${TARGET_NAME}/"
            fi
          fi

          cd frontend
          echo "RAWEB_PUBLIC_BASE=${RAWEB_PUBLIC_BASE}" > .env
          echo "Building frontend with BASE=${RAWEB_PUBLIC_BASE}"
          pnpm run build --config vite.config.public.ts
          echo "success=true" >> $GITHUB_OUTPUT

          # replace index.html with a version that redirects to /docs/
          mv dist/index.html dist/_index.html
          touch dist/index.html
          echo '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Redirecting...</title><meta http-equiv="refresh" content="0; url=./docs/"><link rel="canonical" href="./docs/"></head><body>If you are not redirected automatically, follow this <a href="./docs/">link to documentation</a>.</body></html>' > dist/index.html

          # save the output to a known location for the next step
          mv dist $RUNNER_TEMP/raweb-frontend-dist

      - name: Update status
        if: github.event_name == 'pull_request_target'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find_comment.outputs.comment-id || steps.pr_comment.outputs.comment-id }}
          body: |
            <!-- DEPLOY-PREVIEW-COMMENT -->
            üèóÔ∏è **Transferring build artifacts...**
            [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            <div>
            <b>Local install</b></br>
            Run as an administrator in PowerShell to install this branch:

            ```bash
            iwr -UseBasicParsing install.raweb.app/preview/${{ github.event.pull_request.head.repo.owner.login || github.repository_owner }}/${{ steps.context.outputs.ref_name }} | iex
            ```
            </div>
          edit-mode: replace

      - name: Push to gh-pages branch
        id: push
        if: steps.build.outcome == 'success'
        env:
          CUSTOM_DOMAIN: ${{ steps.domain.outputs.custom_domain }}
          TARGET_NAME: ${{ steps.context.outputs.target_name }}
        continue-on-error: ${{ github.event_name == 'pull_request_target' }}
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

          set +e
          git fetch origin gh-pages
          fetch_status=$?
          set -e

          if [ $fetch_status -ne 0 ]; then
            git checkout --orphan gh-pages
          else
            git checkout gh-pages
          fi

          if [ "${TARGET_NAME}" = "master" ]; then
            find . -maxdepth 1 -not -name '.' -not -name '..' -not -name '.git' -not -name 'deploy-preview' -exec rm -rf {} +
            cp -r $RUNNER_TEMP/raweb-frontend-dist/* .
            git add .
            git commit -m "chore: update production site" || echo "No changes"
          else
            rm -rf "deploy-preview/${TARGET_NAME}"
            mkdir -p "deploy-preview/${TARGET_NAME}"
            cp -r $RUNNER_TEMP/raweb-frontend-dist/* "deploy-preview/${TARGET_NAME}/"
            git add deploy-preview/${TARGET_NAME}
            git commit -m "chore: update deploy preview for ${TARGET_NAME}" || echo "No changes"
          fi

          echo "Attempting to push to gh-pages..."
          if ! git push origin gh-pages; then
            echo "::warning::Skipping deploy ‚Äî no gh-pages permission."
            echo "success=false" >> $GITHUB_OUTPUT
            echo "reason=No permission to push to gh-pages" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "success=true" >> $GITHUB_OUTPUT

          if [ "${TARGET_NAME}" = "master" ]; then
            if [ -n "${CUSTOM_DOMAIN}" ]; then
              echo "deploy_url=https://${CUSTOM_DOMAIN}/" >> $GITHUB_OUTPUT
            else
              echo "deploy_url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_OUTPUT
            fi
          else
            if [ -n "${CUSTOM_DOMAIN}" ]; then
              echo "deploy_url=https://${CUSTOM_DOMAIN}/deploy-preview/${TARGET_NAME}/" >> $GITHUB_OUTPUT
            else
              echo "deploy_url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/deploy-preview/${TARGET_NAME}/" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Update status (successful build)
        if: github.event_name == 'pull_request_target' && steps.push.outputs.success == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find_comment.outputs.comment-id || steps.pr_comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            <!-- DEPLOY-PREVIEW-COMMENT -->
            ‚è≥ **Waiting for runner...**
            [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            <div>
            <b>Local install</b></br>
            Run as an administrator in PowerShell to install this branch:

            ```bash
            iwr -UseBasicParsing install.raweb.app/preview/${{ github.event.pull_request.head.repo.owner.login || github.repository_owner }}/${{ steps.context.outputs.ref_name }} | iex
            ```
            </div>

      - name: Update status (skipped)
        if: github.event_name == 'pull_request_target' && steps.push.outputs.reason != '' && steps.push.outputs.success != 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find_comment.outputs.comment-id || steps.pr_comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            <!-- DEPLOY-PREVIEW-COMMENT -->
            ### ‚ö†Ô∏è Deployment skipped

            Reason: _${{ steps.push.outputs.reason }}_
            [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            <div>
            <b>Local install</b></br>
            Run as an administrator in PowerShell to install this branch:

            ```bash
            iwr -UseBasicParsing install.raweb.app/preview/${{ github.event.pull_request.head.repo.owner.login || github.repository_owner }}/${{ steps.context.outputs.ref_name }} | iex
            ```
            </div>

      - name: Update status (failure)
        if: github.event_name == 'pull_request_target' && (steps.build.outcome != 'success' || (steps.push.outputs.success != 'true' && steps.push.outputs.reason == ''))
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find_comment.outputs.comment-id || steps.pr_comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            <!-- DEPLOY-PREVIEW-COMMENT -->
            ### ‚ùå Deployment failed

            There was an error during the build or deploy phase.
            [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            <div>
            <b>Local install</b></br>
            Run as an administrator in PowerShell to install this branch:

            ```bash
            iwr -UseBasicParsing install.raweb.app/preview/${{ github.event.pull_request.head.repo.owner.login || github.repository_owner }}/${{ steps.context.outputs.ref_name }} | iex
            ```
            </div>
      - name: Fail job
        if: github.event_name == 'pull_request_target' && (steps.build.outcome != 'success' || (steps.push.outputs.success != 'true' && steps.push.outputs.reason == ''))
        run: |
          echo "Build or push failed. Please check the logs for more details."
          exit 1

  build-guacd:
    name: Build guacd WSL distribution
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Build guacd WSL distribution
        id: guacd
        uses: ./.github/actions/build-guacd

      - name: Upload guacd.wsl artifact
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: guacd.wsl
          path: ${{ steps.guacd.outputs.guacd_path }}

  build-server:
    name: Build server (backend)
    runs-on: windows-latest
    needs: build-guacd

    env:
      NUGET_PACKAGES: ${{ github.workspace }}/.nuget/packages

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Stub /bin/bash to system bash
        if: ${{ env.ACT }}
        shell: pwsh
        run: |
          # add the Git for Windows bin directory to the PATH
          "$env:ProgramFiles\Git\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.11
          run_install: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.15.0"
          cache: "pnpm"
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        run: cd frontend && pnpm install

      - name: Build the frontend
        run: cd frontend && pnpm run build

      - name: Set up .NET
        uses: actions/setup-dotnet@v5
        if: ${{ !env.ACT }}
        with:
          dotnet-version: "8.0.x"
          cache: false

      - name: Restore .NET solution
        run: dotnet restore RAWeb.sln --locked-mode

      - name: Build .NET solution
        run: |
          $version = [System.DateTime]::UtcNow.ToString('yyyy.MM.dd.HHmm') + "-unstable"
          dotnet build RAWeb.sln --configuration Release --no-restore -p:FileVersion=$version

      - name: Replace App_Code and bin directories with build output
        shell: bash
        run: |
          rm -rf dotnet/RAWebServer/App_Code
          rm -rf dotnet/RAWebServer/src
          rm -rf dotnet/RAWebServer/ext
          rm -rf dotnet/RAWebServer/obj
          rm -rf dotnet/RAWebServer/bin
          rm -rf dotnet/RAWebServer/RAWebServer.csproj
          rm -rf dotnet/RAWebServer/packages.lock.json
          rm -rf dotnet/RAWebServer/.gitignore
          rm -rf dotnet/RAWebServer/.vscode
          cp -r dotnet/RAWebServer/build/bin dotnet/RAWebServer/bin
          rm -rf dotnet/RAWebServer/build

      - name: Download guacd.wsl
        uses: actions/download-artifact@v4
        with:
          name: guacd.wsl
          path: dotnet/RAWebServer/bin

      - name: Confirm guacd.wsl is present
        shell: bash
        run: |
          if [ ! -f "dotnet/RAWebServer/bin/guacd.wsl" ]; then
            echo "guacd.wsl not found in expected location: dotnet/RAWebServer/bin/guacd.wsl"
            exit 1
          fi

      - name: Move repository setup.ps1 to dotnet/RAWebServer so it is included in the release archive
        shell: bash
        run: |
          mv setup.ps1 dotnet/RAWebServer/setup.ps1

      # modify setup.ps1 to replace $source_dir = "dotnet\RAWebServer" with $source_dir = ""
      # since the setup.ps1 is now in the same folder as the files to install
      - name: Modify setup.ps1 for altered location
        shell: bash
        run: |
          find='$source_dir = "dotnet\\RAWebServer"'
          replace='$source_dir = ""'
          file='dotnet/RAWebServer/setup.ps1'

          sed -i "s|$find|$replace|g" "$file"

      # include an empty frontend directory (the installer quits without it)
      - name: Create empty frontend directory
        shell: bash
        run: |
          mkdir -p dotnet/RAWebServer/frontend

      - name: Generate archive
        uses: thedoctor0/zip-release@0.7.5
        with:
          type: "zip"
          directory: dotnet/RAWebServer/
          filename: "../../build/raweb_dev.zip"

      - name: Upload build output
        uses: actions/upload-artifact@v4
        with:
          name: build
          path: ./build/raweb_dev.zip
          compression-level: 0 # no double-zipping (already a zip file)

  deploy-pages:
    name: Deploy to GitHub Pages
    needs: build-and-preview
    runs-on: ubuntu-latest

    if: >-
      ${{ !github.event.act &&
          needs.build-and-preview.outputs.preview_success == 'true' &&
          needs.build-and-preview.outputs.skipped != 'true' &&
          needs.build-and-preview.outputs.failed != 'true' }}

    environment:
      name: ${{ needs.build-and-preview.outputs.ref_name == 'master' && 'Production' || (github.event_name == 'pull_request_target' && 'Review' || 'Development') }}
      url: ${{ needs.build-and-preview.outputs.deploy_url }}

    steps:
      - name: Find existing PR comment
        if: github.event_name == 'pull_request_target'
        id: find_comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body-includes: "<!-- DEPLOY-PREVIEW-COMMENT -->"

      - name: Update PR comment (deploying)
        if: github.event_name == 'pull_request_target'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            <!-- DEPLOY-PREVIEW-COMMENT -->
            **üåê Deploying...**
            [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            <div>
            <b>Local install</b></br>
            Run as an administrator in PowerShell to install this branch:

            ```bash
            iwr -UseBasicParsing install.raweb.app/preview/${{ github.event.pull_request.head.repo.owner.login || github.repository_owner }}/${{ needs.build-and-preview.outputs.ref_name }} | iex
            ```
            </div>

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload gh-pages content as artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Update PR comment (successfull deployment)
        if: ${{ github.event_name == 'pull_request_target' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            <!-- DEPLOY-PREVIEW-COMMENT -->
            ### ‚úÖ **Deployment successful**

            Preview URL: [${{ needs.build-and-preview.outputs.deploy_url }}](${{ needs.build-and-preview.outputs.deploy_url }})
            Wiki/Docs: [${{ needs.build-and-preview.outputs.deploy_url }}docs/](${{ needs.build-and-preview.outputs.deploy_url }}docs/)

            <div>
            <b>Local install</b></br>
            Run as an administrator in PowerShell to install this branch:

            ```bash
            iwr -UseBasicParsing install.raweb.app/preview/${{ github.event.pull_request.head.repo.owner.login || github.repository_owner }}/${{ needs.build-and-preview.outputs.ref_name }} | iex
            ```
            </div>

            [View logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
